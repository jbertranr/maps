<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <title>jQM Complex Demo</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=no; target-densityDpi=device-dpi"-->
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />
        <link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css" />
        <link rel="stylesheet" type="text/css" href="../js/leaflet-openweathermap/leaflet-openweathermap.css" />
		<style>		
			#map { 
				margin:-15px;
				height: 100%;
				width:100%; 
			}
		</style>
        <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>
        <script type="text/javascript" src="http://leafletjs.com/dist/leaflet.js"></script>
        <script type="text/javascript" src="../js/leaflet-openweathermap/leaflet-openweathermap.js"></script>
        <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
        <script src="../js/leaflet-plugins-master/layer/tile/Google.js"></script>
		<script type="text/javascript">	
		
		var visor = {
			map : {}, // 	Objecte OpenLayers del mapa
			greenIcon : {},
			config : { layers : { base : [], overlay : [] }
			}
		}
				
		function ajustaFinestres(){			
			var resizeTimer = null;			
			if (resizeTimer) clearTimeout(resizeTimer);			
			resizeTimer = setTimeout(function () {
				$('#map').width($(window).width());
				$('#map').height($(window).height() - $('#header').height() - $('#footer').height()- 5);
				visor.map._onResize(); 	;
			});
		}
		 
		function baseLayer(Seleccionada){			
			 $.each(visor.config.layers.base, function(i,item){
				 if (visor.map.hasLayer(item)){
					  visor.map.removeLayer(item);				  
				 }			 
			 });
			 
			 Seleccionada.addTo(visor.map);
		}
		
		function overlayLayer(seleccionada){			
			 seleccionada.addTo(visor.map);
			 seleccionada.setOpacity(0.5);
			 
		}
		
		function removeAllOverlay(){
			 $.each(visor.config.layers.overlay, function(i,item){
				 if (visor.map.hasLayer(item)){
					  visor.map.removeLayer(item);
					  return false;
				 }			 
			 });			
		}
		
		function nextOverlayLayer(count){			 
			var overlayLayersLength = visor.config.layers.overlay.length;
			var mostra = null;			
			
			$.each(visor.config.layers.overlay, function(i,item){
				mostra = i + count;
				// Selecciona la capa overlay activa   
				if (visor.map.hasLayer(item)){
					// Si és el darrer i és demana el següent torna a començar
					if (i == overlayLayersLength - 1 && count > 0 ){
						mostra = 0;				
					}
					// Si és el primer i es demana l'anterior
					if (i == 0 && count < 0 ){
						mostra = overlayLayersLength - 1;
					}
					removeAllOverlay();
					overlayLayer(visor.config.layers.overlay[mostra]);
					$('#layerName').html(visor.config.layers.overlay[mostra].options.id);
					return false;
				}	
				// Si no hi ha cap capa activa selecciona la primera
				if (i == overlayLayersLength - 1) {
					overlayLayer(visor.config.layers.overlay[0]);
					$('#layerName').html(visor.config.layers.overlay[0].options.id);
				}
				
			});
		}	
		 
		function creaHome(){
			 
			var titolHeader = 'Aquest és el nou títol';
			 
			 
			 $('#header')
			 	.html('')
			    .append('	<a href="#" class="ui-btn-left ui-btn ui-icon-home ui-btn-icon-left ui-shadow ui-corner-all">Home</a>'
			    		+ ' <h1 class="ui-title" role="heading" aria-level="1"> '
			    		+ titolHeader
			    		+ '</h1> '
			    		+ ' <a href="#" class="ui-btn-right ui-btn ui-icon-home ui-btn-icon-left ui-shadow ui-corner-all">Search</a>');
			  
			 if ($('#map').length == 0){
				 $('#contMapa')			 	
				    .append('<div id="map"></div>' );				 
			 }
		
			 
			 $('#footer')
			 	.html('')
			    .append('	<div data-role="controlgroup" data-type="horizontal" data-inline="true">'
						+ ' <a  style="margin-top: -88px;" onclick="nextOverlayLayer(-1)" href="#" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-btn-inline ui-icon-arrow-l"></a>'
			    		+ ' <a  style="margin-top: -88px;width:120px" id="layerName" href="#" class="ui-btn ">Layers</a>'
						+ ' <a  style="margin-top: -88px;" onclick="nextOverlayLayer(1)" href="#" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-btn-inline ui-icon-arrow-r"></a>'
			    		+ ' <a onclick="baseLayer(visor.config.layers.base[0])" href="#" class="ui-btn ">Map</a>'
			    		+ ' <a onclick="baseLayer(visor.config.layers.base[1])" href="#" class="ui-btn ">Sat</a>'
						+ ' <a href="#pagetwo" class="ui-btn ui-icon-cloud ui-btn-icon-left">Cloud Anchor</a>'
      					+ '</div>' );
		 
			 $('#index').trigger('pagecreate');
			 
			 ajustaFinestres();			 
		 }
	 
		 	
			 $(document).on('pagebeforeshow', '#index', function(){ });   
			 
			 $(document).on('pageshow','#pageone', function(){ 		
		    // The web service URL from Drive 'Deploy as web app' dialog.
				
			creaHome();
		    $(window).bind('resize', function () {ajustaFinestres();});
			visor.map = L.map('map');
			
			visor.greenIcon = L.icon({
				iconUrl: 'http://leafletjs.com/docs/images/leaf-green.png',
				shadowUrl: 'http://leafletjs.com/docs/images/leaf-shadow.png',
				iconSize:     [19, 47], // size of the icon
				shadowSize:   [25, 32], // size of the shadow
				iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				shadowAnchor: [4, 62],  // the same for the shadow
				popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});
				
     		
			// Definició de capes
			
			var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
				attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
			});
			
			
			
			var icc = L.tileLayer('http://geoserveis.icc.cat/icc_mapesbase/wms/service', {
					id:'ICGC',
					layers: 'mtc5m',
				    format: 'image/png',
				   // transparent: true,
				    attribution: 'ICGC'
				});			
			
			var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				id: 'osm',
				attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
			});
			
			var esri = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
				id:'esri',
				attribution: 'Tiles &copy; Esri &mdash; Source: US National Park Service',
				maxZoom: 8
			});
			
			
			var nexrad = L.tileLayer.wms("http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi", {
				id:'nexrad',
				layers: 'nexrad-n0r-900913',
			    format: 'image/png',
			    transparent: true,
			    attribution: "Weather data © 2012 IEM Nexrad"
			});
			
			var SST = L.tileLayer.wms("http://myocean.artov.isac.cnr.it/thredds/wms/SST_MED_SST_L4_NRT_OBSERVATIONS_010_004_c_V2",{
				id:'SST',
				layers: 'analysed_sst',
			    format: 'image/png',
			    transparent: true,
			    attribution: ""
			});
				
				
			var SSWVW= L.tileLayer.wms("http://gnoodap.bo.ingv.it/thredds/wms/myov03-med-ingv-cur-an-fc",{
				id:'SSWVW',
				layers: 'surface_sea_water_velocity_produced_by_sea_surface_waves',
			    format: 'image/png',
			    transparent: true,
			    attribution: ""
			});
					
				
			
			
			
			
			var clouds = L.OWM.clouds({id:'cloud'});
			
			var temp = L.OWM.temperature({id:'temp'});
			
			var cloudscls = L.OWM.cloudsClassic({id:'cloudscl'});
		    
			var precipitation = L.OWM.precipitation({id:'precipitation'});
		    
			var precipitationcls = L.OWM.precipitationClassic({id:'precipitationcls'});
		    
			var rain = L.OWM.rain({id:'rain'});
		    
			var raincls = L.OWM.rainClassic({id:'raincls'});
		    
			var snow = L.OWM.snow({id:'snow'});
		    
			var pressure = L.OWM.pressure({id:'pressure'});
		    
			var pressurecntr = L.OWM.pressureContour({id:'pressurecntr'});
		    
			var temp = L.OWM.temperature({id:'temp'});
		    
			var wind = L.OWM.wind({id:'wind'});

			var ggl = new L.Google('');
			
			//var ggl2 = new L.Google('TERRAIN');
	
			
			visor.config.layers.base = [osm , Esri_WorldImagery ];
			visor.config.layers.overlay = [SST, SSWVW, clouds, cloudscls, temp, precipitation, precipitationcls, rain, raincls, snow, pressure, pressurecntr, wind ];
			baseLayer(osm);
			visor.map.setView([51.505, -0.09], 13);	
			ajustaFinestres();
			
			var baseMaps = {
				    "Mapa": visor.config.layers.base[0],
				    "Satèl·lit": visor.config.layers.base[1]
			};
			
			
			var overlayMaps ={
					"Núvols": visor.config.layers.overlay[2],
					"Temperature": visor.config.layers.overlay[6]
			};
		
			
			//L.control.layers(baseMaps, overlayMaps).addTo(visor.map);
			
			
	
		
			// add an OpenStreetMap tile layer
			// add a marker in the given location, attach some popup content to it and open the popup
			/*
				L.marker([51.5, -0.09]).addTo(map)
				.bindPopup('A pretty CSS3 popup. <br> Easily customizable.')
				.openPopup();
			*/	

		});

/*		function onLocationFound(e) {			
			var radius = e.accuracy / 2;			
			L.marker(e.latlng).addTo(map)
			.bindPopup("You are within " + radius + " meters from this point").openPopup();			
			L.circle(e.latlng, radius).addTo(map);
		}

		function onLocationError(e) {
			L.map('map').setView([51.505, -0.09], 13);
		}
*/

		
	</script>
		
		
    </head>
    <body>
    	 
    	<div data-role="page" id="pageone">  
            <div data-role="header"  role="banner" id = "header"> </div>           
            <div data-role="content" id="contMapa"> </div>               
            <div data-role="footer"  id = "footer"> </div>
        </div>
        
       <div data-role="page" data-dialog="true" data-transition="slidedown" id="pagetwo">
		  <div data-role="header">
		    <h1>I'm A Dialog Box!</h1>
		  </div>
		
		  <div data-role="main" class="ui-content">
		    <p>The dialog box is different from a normal page, it is displayed on top of the current page and it will not span the entire width of the page. The dialog has also an icon of "X" in the header to close the box.</p>
		    <a href="#pageone">Go to Page One</a>
		  </div>
		
		  <div data-role="footer">
		    <h1>Footer Text In Dialog</h1>
		  </div>
		</div> 
		
		
    </body>
</html>   